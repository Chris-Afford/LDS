<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Scoreboard</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #111;
            color: #fff;
            padding: 30px;
        }
        .horse-ids {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .horse {
            position: relative;
            width: 15%;
            text-align: center;
            font-size: 5em;
            font-weight: bold;
        }
        .horse .position {
            position: absolute;
            bottom: 5px;
            left: 5px;
            font-size: 0.3em;
            color: #ff0;
        }
        .divider {
            border-top: 2px solid #fff;
            margin: 20px 0;
        }
        .center-info {
            text-align: center;
            font-size: 2em;
            margin-bottom: 15px;
        }
        .messages {
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 20px;
        }
        .results {
            text-align: center;
            font-size: 1.2em;
        }
        .result-line { margin: 3px 0; }
    </style>
</head>
<body>
    <div class="horse-ids" id="horse-ids"></div>
    <div class="divider"></div>
    <div class="center-info" id="venue-track">Venue - Track</div>
    <div class="messages">
        <div id="message1"></div>
        <div id="message2"></div>
    </div>
    <div class="results" id="results"></div>

    <script>
        function getClubIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get("club_id");
        }

        const clubId = getClubIdFromURL();

        if (!clubId) {
            document.body.innerHTML = "<h2 style='color:red'>Error: No club ID provided in URL.</h2>";
            throw new Error("Missing club_id in URL");
        }

        const ws = new WebSocket(`wss://${location.host}/scoreboard/ws/${clubId}`);

        ws.onopen = () => {
            console.log("WebSocket connected");
        };

        ws.onerror = (err) => {
            console.error("WebSocket error:", err);
        };

        ws.onmessage = (event) => {
            console.log("Received data:", event.data);
            const data = JSON.parse(event.data);

            const horseEl = document.getElementById("horse-ids");
            horseEl.innerHTML = "";
            if (data.runners) {
                const ids = data.runners.slice(0, 6).map(r => r.trim().split(/\s+/)[0]);
                ids.forEach((id, idx) => {
                    const h = document.createElement("div");
                    h.className = "horse";
                    h.innerHTML = `<span class="number">${id}</span><span class="position">${idx + 1}</span>`;
                    horseEl.appendChild(h);
                });
            }

            document.getElementById("venue-track").textContent =
                `${data.venue_name || ""} - ${data.track_condition || ""}`;
            document.getElementById("message1").textContent =
                data.message1 ? `Margins: ${data.message1}` : "";
            document.getElementById("message2").textContent =
                data.message2 ? `Announcement: ${data.message2}` : "";

            const resultsEl = document.getElementById("results");
            resultsEl.innerHTML = "";
            if (data.runners) {
                data.runners.forEach((runner) => {
                    const line = document.createElement("div");
                    line.className = "result-line";
                    line.textContent = runner;
                    resultsEl.appendChild(line);
                });
            }
        };
    </script>
</body>
</html>
